<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <!-- Only works in online mode <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous"> -->
    <!-- Works offline --> <link rel="stylesheet" href="bootstrap.min.css">
    <style>
        .m-flex-1 {
            flex: 1
        }

        html, body, #settingsPage {
            height: 100%;
        }
    </style>
    <title>Chain Grinder</title>
  </head>
  <body class="d-flex flex-column">
    <div class="d-flex justify-content-between ml-3 mr-3" id="statusBar">
        <label class="nav-link">KEDJE SLIP</label>
        <label class="nav-link" id="statusLabel">Ansluter - </label>
        <label class="nav-link" id="timeLabel"></label>
    </div>
    <div id="settingsPage" class="m-flex-1">
            <div class="d-flex m-flex-1 mt-3">
                <button class="btn btn-success m-flex-1 ml-3 mr-5" type="button" onclick="lowerTapped()">Sänk slip</button>
                <button class="btn btn-success m-flex-1 mr-3" type="button" onclick="liftTapped()">Höj slip</button>
            </div>
            <div class="d-flex m-flex-1 mt-3">
                <button class="btn btn-success m-flex-1 ml-3 mr-5" type="button" onclick="alterAngleTapped()">Vinkla slip</button>
                <button class="btn btn-success m-flex-1 mr-3" type="button" onclick="setupSequenceTapped()">Starta inställnings sekvens</button>
            </div>
        </div>
    </div>
    <div id="homePage" class="m-flex-1">
        <div class="d-flex m-flex-1 mr-3 ml-3">
            <div class="input-group mb-3">
                <div class="input-group-prepend">
                    <span class="input-group-text" id="basic-addon1">Antal tänder</span>
                </div>
                <input type="text" class="form-control" placeholder="Antal tänder">
                </div>                  
            </div>
            <div class="d-flex m-flex-1 mt-3">
                <button class="btn btn-danger m-flex-1 ml-3 mr-5" type="button" onclick="">Avbryt</button>
                <button class="btn btn-success m-flex-1 mr-3" type="button" onclick="">Starta</button>
            </div>
            <div class="d-flex m-flex-1 mt-3 ml-3 mr-3">
                <div class="input-group-prepend m-flex-1 mr-5">
                    <span class="input-group-text" id="basic-addon1">Totalt antal tänder: </span>
                </div>
                <div class="input-group-prepend m-flex-1">
                    <span class="input-group-text" id="basic-addon1">Antal tänder kvar: </span>
                </div>
            </div>
        </div>
    </div>
    <nav class="navbar navbar-light" style="background-color: #e3f2fd;">
        <div class="d-flex flex-row m-flex-1" id="navbarNav">
            <button class="btn btn-success m-flex-1 mr-5" type="button" onclick="settingsTapped()">Inställningar</button>
            <button class="btn btn-success m-flex-1" type="button" onclick="homeTapped()">Hem</button>
        </div>
    </nav>
    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js" integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js" integrity="sha384-B4gt1jrGC7Jh4AgTPSdUtOBvfO8shuf57BaghqFfPlYxofvL8/KUEfYiJOMMV+rV" crossorigin="anonymous"></script>
    <script type="text/javascript">
        let socket 
        const statusLabel = document.getElementById('statusLabel')
        const timeLabel = document.getElementById('timeLabel')
        const settingsPage = document.getElementById('settingsPage')
        const homePage = document.getElementById('homePage')

        let grinder = {
            status: 'RESTING',
            settings: {
                numberOfTooth: 0,
            }
        }
        
        function onLoad() {
            connect()
            settingsTapped()
            displayCurrentTime()
            checkStatus()
        }

        onLoad()

        function checkStatus() {

        }


        ///////////////////////////// Socket stuff ////////////////////////////////////////

        function connect() {
            statusLabel.innerHTML = 'Status: Connecting...'
            socket = new WebSocket('ws://192.168.0.9:8080')

            socket.onopen = () => {
                console.log('Connected')
                statusLabel.innerHTML = 'Ansluten - Vilar'
                socket.send('Hello world')
            }
    
            socket.onmessage = (evt) => {
                console.log('Recieved message: ', evt.data)
            }
    
            socket.onclose = () => {
                console.log('Connection is closed')
                statusLabel.innerHTML = 'Ansluter... -'
                setTimeout(function() {
                    connect();
                }, 1000);
            }

            socket.onerror = (err) => {
                console.error('Socket encountered error: ', err.message, 'Closing socket');
                socket.close();
            };
        }


        //////////////////////////  Navbar stuff //////////////////////////////////


        function settingsTapped() {
            console.log('Settings tapped')
            homePage.style.visibility = 'hidden'
            homePage.style.height = '0'
            homePage.classList.remove('m-flex-1')
            settingsPage.style.visibility = 'visible'
            settingsPage.classList.add('m-flex-1')
        }

        function homeTapped() {
            console.log('Home tapped')
            settingsPage.style.visibility = 'hidden'
            settingsPage.style.height = '0'
            settingsPage.classList.remove('m-flex-1')
            homePage.style.visibility = 'visible'
            homePage.classList.add('m-flex-1')
        }

        ////////////////////////// Grinder stuff ////////////////////////////////

        function lowerTapped() {
            socket.send('LOWER')
        }

        function liftTapped() {
            socket.send('LIFT')
        }

        function alterAngleTapped() {
            socket.send('ALTER ANGLE')
        }

        function setupSequenceTapped() {
            socket.send('SETUP SEQUENCE')
        }

        ///////////////////////// Time stuff /////////////////////////////////

        function displayCurrentTime() {
            const today = new Date();
            const year = today.getFullYear()
            const month = today.getMonth() + 1
            const day = today.getDate()
            const h = today.getHours();
            let m = today.getMinutes();
            m = padWithZero(m);
            timeLabel.innerHTML = `${year}-${padWithZero(month)}-${padWithZero(day)} ${h}:${m}`
            setTimeout(displayCurrentTime, 1000);
        }

        function padWithZero(i) {
            if (i < 10) {i = "0" + i};  // add zero in front of numbers < 10
            return i;
        }


    </script>
  </body>
</html>