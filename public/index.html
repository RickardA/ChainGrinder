<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <!-- Only works in online mode <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous"> -->
    <!-- Works offline --> <link rel="stylesheet" href="bootstrap.min.css">
    <style>
        .m-flex-1 {
            flex: 1
        }

        html, body, #settingsPage {
            height: 100%;
        }
    </style>
    <title>Chain Grinder</title>
  </head>
  <body class="d-flex flex-column">
    <div class="d-flex justify-content-between ml-3 mr-3" id="statusBar">
        <label class="nav-link">KEDJE SLIP</label>
        <label class="nav-link" id="statusLabel">Ansluter - </label>
        <label class="nav-link" id="timeLabel"></label>
    </div>
    <div id="settingsPage" class="m-flex-1">
            <div class="d-flex m-flex-1 mt-3">
                <button class="btn btn-success m-flex-1 ml-3 mr-5" type="button" onclick="lowerTapped()">Sänk slip</button>
                <button class="btn btn-success m-flex-1 mr-3" type="button" onclick="liftTapped()">Höj slip</button>
            </div>
            <div class="d-flex m-flex-1 mt-3">
                <button class="btn btn-success m-flex-1 ml-3 mr-5" type="button" onclick="alterAngleTapped()">Vinkla slip</button>
                <button class="btn btn-success m-flex-1 mr-3" type="button" onclick="setupSequenceTapped()">Starta inställnings sekvens</button>
            </div>
        </div>
    </div>
    <div id="homePage" class="m-flex-1">
        <div class="d-flex m-flex-1 mr-3 ml-3">
            <div class="input-group mb-3">
                <div class="input-group-prepend">
                    <span class="input-group-text">Antal tänder</span>
                </div>
                <input type="text" class="form-control" id="toothInput" placeholder="Antal tänder">
                <div class="input-group-append">
					<button class="btn btn-success m-flex-1 mr-3" type="button" id="toothInputOK" onclick="setNumberOfTooths()">Tillämpa</button>
                </div>
                </div>                  
            </div>
            <div class="d-flex m-flex-1 mt-3">
                <button class="btn btn-danger m-flex-1 ml-3 mr-5" type="button" onclick="stop()">Avbryt</button>
                <button class="btn btn-success m-flex-1 mr-3" type="button" onclick="start()">Starta</button>
            </div>
            <div class="d-flex m-flex-1 mt-3 ml-3 mr-3">
                <div class="input-group-prepend m-flex-1 mr-5">
                    <span class="input-group-text" id="totalTooths">Totalt antal tänder: </span>
                </div>
                <div class="input-group-prepend m-flex-1">
                    <span class="input-group-text" id="toothsLeft">Antal tänder kvar: </span>
                </div>
            </div>
        </div>
    </div>
    <nav class="navbar navbar-light" style="background-color: #e3f2fd;">
        <div class="d-flex flex-row m-flex-1" id="navbarNav">
            <button class="btn btn-success m-flex-1 mr-5" type="button" onclick="settingsTapped()">Inställningar</button>
            <button class="btn btn-success m-flex-1" type="button" onclick="homeTapped()">Hem</button>
        </div>
    </nav>
    <script type="text/javascript">
        let socket 
        const statusLabel = document.getElementById('statusLabel')
        const timeLabel = document.getElementById('timeLabel')
        const settingsPage = document.getElementById('settingsPage')
        const homePage = document.getElementById('homePage')
        const toothInput = document.getElementById('toothInput')
        const toothInputOK = document.getElementById('toothInputOK')
        const totalTooths = document.getElementById('totalTooths')
        const toothsLeft = document.getElementById('toothsLeft')
        
        toothInput.oninput = inputChanged
        toothInputOK.disabled = true
        
        let connected = false

        let grinder = {
            status: 'RESTING',
            numberOfToothsLeft: 0,
            settings: {
                totalNumberOfTooths: 0,
            }
        }
        
        function onLoad() {
            connect()
            settingsTapped()
            displayCurrentTime()
        }

        onLoad()
        
        function handleMessage(msg) {
			switch(msg.type) {
				case 'STATUS':
					updateStatusLabel(msg.status)
				break;
				case 'NUMBEROFTOOTHS':
					updateNumberOfToothsLeft(msg.numberOfToothsLeft)
				break;
				case 'TOTALTOOTHS':
					updateTotalTooths(msg.value)
				break;
				case 'SETTINGS':
					updateSettings(msg.settings)
				break;
				case 'COMPLETE':
					updateEverything(msg.complete)
				break;
			}
		}
		
		function updateTotalTooths(val) {
			grinder.settings.totalNumberOfTooths = val
			totalTooths.innerHTML = `Totalt antal tänder: ${grinder.settings.totalNumberOfTooths}`
		}

		function updateStatusLabel(status) {
			grinder.status = status
			statusLabel.innerHTML = connected ? `Ansluten - ${getStatusMsg()}` : 'Ansluter...'
		}
		
		function updateNumberOfToothsLeft(tooths) {
			grinder.numberOfToothsLeft = tooths
			toothsLeft.innerHTML = `Antal tänder kvar: ${grinder.numberOfToothsLeft}`
		}
		
		function updateSettings(settings) {
			grinder.settings = settings
			totalTooths.innerHTML = `Totalt antal tänder: ${grinder.settings.totalNumberOfTooths}`
		}
		
		function updateEverything(everything) {
			grinder = everything
			updateGUI()
		}
		
		function updateGUI() {
			statusLabel.innerHTML = connected ? `Ansluten - ${getStatusMsg()}` : 'Ansluter...'
			toothsLeft.innerHTML = `Antal tänder kvar: ${grinder.numberOfToothsLeft}`
			totalTooths.innerHTML = `Totalt antal tänder: ${grinder.settings.totalNumberOfTooths}`
		}
		
		function getStatusMsg() {
			switch(grinder.status) {
				case 'RESTING':
					return 'Vilar'
				break;
				case 'LOWERING':
					return 'Sänker...'
				break;
				case 'LIFTING':
					return 'Lyfter...'
				break;
				case 'ALTERING ANGLE':
					return 'Vinklar...'
				break;
				case 'GRINDING':
					return 'Slipar...'
				break;
				case 'STOP':
					return 'Stannar...'
				break;
				case 'SETUP':
					return 'Inställnings Läge'
				break;
			}
			
		}
		
		////////////////////////////// GUI Stuff //////////////////////////////////////////
		
		function inputChanged(e) {
			console.log('Input changed: ', e.target.value)
			if(e.target.value.length > 0) {
				toothInputOK.disabled = false
			} else {
				toothInputOK.disabled = true
			}
		}


        ///////////////////////////// Socket stuff ////////////////////////////////////////

        function connect() {
            connected = false
            updateGUI()
            socket = new WebSocket(`ws://${window.location.hostname}:8080`)

            socket.onopen = () => {
                console.log('Connected')
                connected = true
                updateGUI()
            }
    
            socket.onmessage = (evt) => {
                console.log('Recieved message: ', evt.data)
				handleMessage(JSON.parse(evt.data))
            }
    
            socket.onclose = () => {
                console.log('Connection is closed')
                connected = false
                updateGUI()
                setTimeout(function() {
                    connect();
                }, 1000);
            }

            socket.onerror = (err) => {
                console.error('Socket encountered error: ', err.message, 'Closing socket');
                socket.close();
            };
        }


        //////////////////////////  Navbar stuff //////////////////////////////////


        function settingsTapped() {
            console.log('Settings tapped')
            homePage.style.visibility = 'hidden'
            homePage.style.height = '0'
            homePage.classList.remove('m-flex-1')
            settingsPage.style.visibility = 'visible'
            settingsPage.classList.add('m-flex-1')
        }

        function homeTapped() {
            console.log('Home tapped')
            settingsPage.style.visibility = 'hidden'
            settingsPage.style.height = '0'
            settingsPage.classList.remove('m-flex-1')
            homePage.style.visibility = 'visible'
            homePage.classList.add('m-flex-1')
        }

        ////////////////////////// Grinder stuff ////////////////////////////////
        
        function setNumberOfTooths() {
			console.log('Number of tooths: ', toothInput.value)
			socket.send(JSON.stringify({ command: 'NUMBEROFTOOTHS', value: toothInput.value }))
			toothInput.value = ''
		}

        function lowerTapped() {
            socket.send(JSON.stringify({ command: 'LOWER'}))
        }

        function liftTapped() {
            socket.send(JSON.stringify({ command: 'LIFT'}))
        }

        function alterAngleTapped() {
            socket.send(JSON.stringify({ command: 'ALTER ANGLE'}))
        }

        function setupSequenceTapped() {
            socket.send(JSON.stringify({ command: 'SETUP SEQUENCE'}))
        }

        function start() {
            socket.send(JSON.stringify({ command: 'START' }))
        }

        function stop() {
            socket.send(JSON.stringify({ command: 'STOP' }))
        }

        function status() {
            socket.send(JSON.stringify({ command: 'STATUS' }))
        }

        ///////////////////////// Time stuff /////////////////////////////////

        function displayCurrentTime() {
            const today = new Date();
            const year = today.getFullYear()
            const month = today.getMonth() + 1
            const day = today.getDate()
            const h = today.getHours();
            let m = today.getMinutes();
            m = padWithZero(m);
            timeLabel.innerHTML = `${year}-${padWithZero(month)}-${padWithZero(day)} ${h}:${m}`
            setTimeout(displayCurrentTime, 1000);
        }

        function padWithZero(i) {
            if (i < 10) {i = "0" + i};  // add zero in front of numbers < 10
            return i;
        }


    </script>
  </body>
</html>
