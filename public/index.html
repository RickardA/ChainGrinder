<!doctype html>
<html lang="en">

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <!-- Only works in online mode <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous"> -->
    <!-- Works offline -->
    <link rel="stylesheet" href="bootstrap.min.css">
    <style>
        .m-flex-1 {
            flex: 1
        }

        html,
        body,
        #settingsPage {
            height: 100%;
        }
    </style>
    <title>Chain Grinder</title>
</head>

<body class="d-flex flex-column" style="overflow: hidden;">
    <div class="d-flex justify-content-between ml-3 mr-3" id="statusBar">
        <label class="nav-link">KEDJE SLIP</label>
        <label class="nav-link" id="statusLabel">Ansluter - </label>
        <label class="nav-link" id="timeLabel"></label>
    </div>
    <div id="settingsPage" class="m-flex-1">
        <div class="d-flex m-flex-1 mt-3">
            <button class="btn btn-primary m-flex-1 ml-3 mr-5" id="lowerGrinderBtn" type="button"
                onclick="lowerTapped()">Sänk slip</button>
            <button class="btn btn-danger m-flex-1 mr-3" id="raiseGrinderBtn" type="button" onclick="liftTapped()">Höj
                slip</button>
            <button class="btn btn-primary m-flex-1 ml-3 mr-5" id="angleGrinderBtn" type="button"
                onclick="alterAngleTapped()">Vinkla slip</button>
        </div>
        <div class="d-flex m-flex-1 mt-3">
            <button class="btn btn-primary m-flex-1 ml-3 mr-5" id="moveChainBtn" type="button"
                onclick="moveChain()">Putta Kedja</button>
            <button class="btn btn-primary m-flex-1 mr-3" id="startGrinderBtn" type="button"
                onclick="startGrinder()">Starta slip</button>
            <button class="btn btn-danger m-flex-1 ml-3 mr-5" id="stopGrinderBtn" type="button"
                onclick="stopGrinder()">Stanna slip</button>
        </div>
        <div class="d-flex m-flex-1 mt-3">
            <button class="btn btn-primary m-flex-1 ml-3 mr-5" id="checkLengthGrindingBtn" type="button"
                onclick="checkLengthGrinding()">Konroll Längdslip</button>
            <button class="btn btn-danger m-flex-1 mr-3" id="quitCheckLengthGrindingBtn" type="button"
                onclick="quitCheckLengthGrinding()">Avsluta Kontroll Längdslip</button>
        </div>
        <div class="d-flex m-flex-1 mt-3">
            <button class="btn btn-danger m-flex-1 ml-3 mr-5" id="clapmChainBtn" type="button"
                onclick="clampChain()">Kläm fast kedja</button>
            <button class="btn btn-danger m-flex-1 mr-3" id="releaseChainBtn" type="button"
                onclick="releaseChain()">Släpp
                kedja</button>
        </div>
    </div>
    <div id="homePage" class="m-flex-1">
        <div class="d-flex m-flex-1 mr-3 ml-3">
            <div class="input-group mb-3">
                <div class="input-group-prepend">
                    <span class="input-group-text">Antal tänder</span>
                </div>
                <input type="text" class="form-control" id="toothInput" placeholder="Antal tänder">
                <div class="input-group-append">
                    <button class="btn btn-success m-flex-1 mr-3" type="button" id="toothInputOK"
                        onclick="setNumberOfTooths()">Tillämpa</button>
                </div>
            </div>
        </div>
        <div class="d-flex m-flex-1 mt-3 ml-3 mr-3">
            <label class="btn btn-secondary active">
                <input type="checkbox" id="checkbox" onclick="checkboxClicked()"> Använd Längdslipning
              </label>
        </div>
        <div class="d-flex m-flex-1 mt-3">
            <button class="btn btn-danger m-flex-1 ml-3 mr-5" id="cancelBtn" type="button"
                onclick="stop()">Avbryt</button>
            <button class="btn btn-success m-flex-1 mr-3" id="startBtn" type="button" onclick="start()">Starta</button>
        </div>
        <div class="d-flex m-flex-1 mt-3 ml-3 mr-3">
            <div class="input-group-prepend m-flex-1 mr-5">
                <span class="input-group-text" id="totalTooths">Totalt antal tänder: </span>
            </div>
            <div class="input-group-prepend m-flex-1">
                <span class="input-group-text" id="toothsLeft">Antal tänder kvar: </span>
            </div>
        </div>
    </div>
    </div>
    <nav class="navbar navbar-light" style="background-color: #e3f2fd;">
        <div class="d-flex flex-row m-flex-1" id="navbarNav">
            <button class="btn btn-success m-flex-1 mr-5" type="button" onclick="settingsTapped()">Manuell
                Kontroll</button>
            <button class="btn btn-success m-flex-1" type="button" onclick="homeTapped()">Automatisk Slipning</button>
        </div>
    </nav>
    <script type="text/javascript">
        let socket
        const statusLabel = document.getElementById('statusLabel')
        const timeLabel = document.getElementById('timeLabel')
        const settingsPage = document.getElementById('settingsPage')
        const homePage = document.getElementById('homePage')
        const toothInput = document.getElementById('toothInput')
        const toothInputOK = document.getElementById('toothInputOK')
        const totalTooths = document.getElementById('totalTooths')
        const toothsLeft = document.getElementById('toothsLeft')
        const lowerGrinderBtn = document.getElementById('lowerGrinderBtn')
        const raiseGrinderBtn = document.getElementById('raiseGrinderBtn')
        const angleGrinderBtn = document.getElementById('angleGrinderBtn')
        const cancelBtn = document.getElementById('cancelBtn')
        const startBtn = document.getElementById('startBtn')
        const moveChainBtn = document.getElementById('moveChainBtn')
        const startGrinderBtn = document.getElementById('startGrinderBtn')
        const stopGrinderBtn = document.getElementById('stopGrinderBtn')
        const checkLengthGrindingBtn = document.getElementById('checkLengthGrindingBtn')
        const quitCheckLengthGrindingBtn = document.getElementById('quitCheckLengthGrindingBtn')
        const clapmChainBtn = document.getElementById('clapmChainBtn')
        const releaseChainBtn = document.getElementById('releaseChainBtn')
        const checkbox = document.getElementById('checkbox')


        toothInput.oninput = inputChanged
        toothInputOK.disabled = true

        let connected = false

        let grinder = {
            status: 'RESTING',
            chainClamped: false,
            grinderLowered: false,
            grinderOn: false,
            pushingChain: false,
            lenghtGrinderActive: false,
            angleAltered: false,
            numberOfToothsLeft: 0,
            settings: {
                totalNumberOfTooths: 0,
                lengthGrindingActivated: false,
            }
        }

        function onLoad() {
            connect()
            settingsTapped()
            displayCurrentTime()
        }

        onLoad()

        function handleMessage(msg) {
			console.log("grinder",msg)
            switch (msg.type) {
                case 'STATUS':
                    updateStatusLabel(msg.status)
                    break;
                case 'NUMBEROFTOOTHS':
                    updateNumberOfToothsLeft(msg.numberOfToothsLeft)
                    break;
                case 'TOTALTOOTHS':
                    updateTotalTooths(msg.value)
                    break;
                case 'SETTINGS':
                    updateSettings(msg.settings)
                    break;
                case 'COMPLETE':
                    updateEverything(msg.complete)
                    break;
                case 'CHAINCLAMPED':
                    grinder.chainClamped = msg.val
                    updateSetupButtons()
                    break;
                case 'GRINDERLOWERED':
                    grinder.grinderLowered = msg.val
                    updateSetupButtons()
                    break;
                case 'GRINDERON':
                    grinder.grinderOn = msg.val
                    updateSetupButtons()
                    break;
                case 'CHAINPUSHER':
                    grinder.pushingChain = msg.val
                    updateSetupButtons()
                    break;
                case 'ALTEREDANGLE':
                    grinder.angleAltered = msg.val
                    updateSetupButtons()
                    break;
                case 'LENGHTGRINDER':
                    grinder.lenghtGrinderActive = msg.val
                    updateSetupButtons()
                    break;
                case 'LENGTHGRINDINGACTIVATED':
                    grinder.settings.lengthGrindingActivated = msg.val
                    checkbox.checked = msg.val
            }
        }

        function updateSetupButtons() {
			console.log("updateSetupButtons")
            if (grinder.status.includes('GRINDING')) {
                checkLengthGrindingBtn.disabled = true
                quitCheckLengthGrindingBtn.disabled = true
                angleGrinderBtn.disabled = true
                moveChainBtn.disabled = true
                startGrinderBtn.disabled = true
                stopGrinderBtn.disabled = true
                lowerGrinderBtn.disabled = true
                raiseGrinderBtn.disabled = true
                clapmChainBtn.disabled = true
                releaseChainBtn.disabled = true
                return
            }
            checkLengthGrindingBtn.disabled = grinder.lenghtGrinderActive
            quitCheckLengthGrindingBtn.disabled = !grinder.lenghtGrinderActive
            angleGrinderBtn.disabled = grinder.grinderLowered
            moveChainBtn.disabled = grinder.pushingChain || grinder.chainClamped || grinder.lenghtGrinderActive || grinder.grinderLowered
            startGrinderBtn.disabled = grinder.grinderOn || grinder.grinderLowered
            stopGrinderBtn.disabled = !grinder.grinderOn
            lowerGrinderBtn.disabled = grinder.grinderLowered
            raiseGrinderBtn.disabled = !grinder.grinderLowered
            clapmChainBtn.disabled = grinder.chainClamped || grinder.pushingChain
            releaseChainBtn.disabled = !grinder.chainClamped
        }

        function updateTotalTooths(val) {
            grinder.settings.totalNumberOfTooths = val
            if (grinder.settings.totalNumberOfTooths === 0 || grinder.settings.totalNumberOfTooths == null) {
                startBtn.disabled = true
            } else {
                startBtn.disabled = false
            }
            totalTooths.innerHTML = `Totalt antal tänder: ${grinder.settings.totalNumberOfTooths}`
        }

        function updateStatusLabel(status) {
            if(grinder.status) grinder.status = status
            statusLabel.innerHTML = connected ? `Ansluten - ${getStatusMsg()}` : 'Ansluter...'
            updateButtonsDisabledState()
        }

        function updateNumberOfToothsLeft(tooths) {
            grinder.numberOfToothsLeft = tooths
            toothsLeft.innerHTML = `Antal tänder kvar: ${grinder.numberOfToothsLeft}`
        }

        function updateSettings(settings) {
            grinder.settings = settings
            totalTooths.innerHTML = `Totalt antal tänder: ${grinder.settings.totalNumberOfTooths}`
        }

        function updateEverything(everything) {
			console.log("update everything", everything)
            grinder = everything
            updateGUI()
        }

        function updateGUI() {
			console.log("grind",grinder)
            statusLabel.innerHTML = connected ? `Ansluten - ${getStatusMsg()}` : 'Ansluter...'
            toothsLeft.innerHTML = `Antal tänder kvar: ${grinder.numberOfToothsLeft}`
            totalTooths.innerHTML = `Totalt antal tänder: ${grinder.settings.totalNumberOfTooths}`
            checkbox.checked = grinder.settings.lengthGrindingActivated
            updateButtonsDisabledState()
        }

        function updateButtonsDisabledState() {
            updateSetupButtons()
            if (grinder.status !== 'RESTING') {
                checkbox.disabled = true
                startBtn.disabled = true
                if (grinder.status !== 'GRINDING') {
                    console.log("Disable  cancel button: ", grinder.status)
                    cancelBtn.disabled = true
                } else {
                    cancelBtn.disabled = false
                }
                toothInputOK.disabled = true
            } else {
                if (grinder.settings.totalNumberOfTooths === 0 || grinder.settings.totalNumberOfTooths == null) {
                    startBtn.disabled = true
                } else {
                    startBtn.disabled = false
                }
                cancelBtn.disabled = true
                checkbox.disabled = false
            }
        }

        function getStatusMsg() {
            switch (grinder.status) {
                case 'RESTING':
                    return 'Vilar'
                    break;
                case 'LOWERING':
                    return 'Sänker...'
                    break;
                case 'LIFTING':
                    return 'Lyfter...'
                    break;
                case 'ALTERING ANGLE':
                    return 'Vinklar...'
                    break;
                case 'GRINDING':
                    return 'Slipar...'
                    break;
                case 'STOP':
                    return 'Stannar...'
                    break;
                case 'SETUP':
                    return 'Startar inställnings läge...'
                    break;
                case 'SETUPSTARTED':
                    return 'Inställnings läge aktivt'
                    break;
                case 'STARTINGGRIDNER':
                    return 'Startar slip...'
                    break;
                case 'STOPPINGGRINDER':
                    return 'Stannar slip...'
                    break;
                case 'PUSHINGCHAIN':
                    return 'Flyttar kedja...'
                    break;
                case 'CHECKINGLENGTHGRINDING':
                    return 'Aktiverar inställning av längdslip...'
                    break;
                case 'QUITCHECKLENGTHGRINDING':
                    return 'Avslutar inställning av längdslip...'
                    break;
                case 'RELEASINGCHAIN':
                    return 'Släpper Kedja...'
                    break;
                case 'CLAMPINGCHAIN':
                    return 'Klämmer kedja...'
            }

        }

        ////////////////////////////// GUI Stuff //////////////////////////////////////////

        function inputChanged(e) {
            console.log('Input changed: ', e.target.value)
            if (e.target.value.length > 0) {
                toothInputOK.disabled = false
            } else {
                toothInputOK.disabled = true
            }
        }

        function checkboxClicked(e) {
            console.log("Checkbox changed: ", checkbox.checked)
            socket.send(JSON.stringify({ command: 'LENGTHGRINDINGACTIVE', value: checkbox.checked}))
        }


        ///////////////////////////// Socket stuff ////////////////////////////////////////

        function connect() {
            connected = false
            updateGUI()
            socket = new WebSocket(`ws://${window.location.hostname}:8080`)

            socket.onopen = () => {
                console.log('Connected')
                connected = true
                updateGUI()
            }

            socket.onmessage = (evt) => {
                console.log('Recieved message: ', evt.data)
                handleMessage(JSON.parse(evt.data))
            }

            socket.onclose = () => {
                console.log('Connection is closed')
                connected = false
                updateGUI()
                setTimeout(function () {
                    connect();
                }, 1000);
            }

            socket.onerror = (err) => {
                console.error('Socket encountered error: ', err.message, 'Closing socket');
                socket.close();
            };
        }


        //////////////////////////  Navbar stuff //////////////////////////////////


        function settingsTapped() {
            console.log('Settings tapped')
            homePage.style.visibility = 'hidden'
            homePage.style.height = '0'
            homePage.classList.remove('m-flex-1')
            settingsPage.style.visibility = 'visible'
            settingsPage.classList.add('m-flex-1')
        }

        function homeTapped() {
            console.log('Home tapped')
            settingsPage.style.visibility = 'hidden'
            settingsPage.style.height = '0'
            settingsPage.classList.remove('m-flex-1')
            homePage.style.visibility = 'visible'
            homePage.classList.add('m-flex-1')
        }

        ////////////////////////// Grinder stuff ////////////////////////////////

        function setNumberOfTooths() {
            console.log('Number of tooths: ', toothInput.value)
            socket.send(JSON.stringify({ command: 'NUMBEROFTOOTHS', value: parseInt(toothInput.value) }))
            toothInput.value = ''
            toothInputOK.disabled = true
        }

        function lowerTapped() {
            socket.send(JSON.stringify({ command: 'LOWER' }))
        }

        function liftTapped() {
            socket.send(JSON.stringify({ command: 'LIFT' }))
        }

        function alterAngleTapped() {
            socket.send(JSON.stringify({ command: 'ALTER ANGLE' }))
        }

        function setupSequenceTapped() {
            socket.send(JSON.stringify({ command: 'SETUP SEQUENCE' }))
        }

        function start() {
            socket.send(JSON.stringify({ command: 'START' }))
        }

        function stop() {
            socket.send(JSON.stringify({ command: 'STOP' }))
        }

        function status() {
            socket.send(JSON.stringify({ command: 'STATUS' }))
        }

        function startGrinder() {
            socket.send(JSON.stringify({ command: 'STARTGRINDER' }))
        }

        function stopGrinder() {
            socket.send(JSON.stringify({ command: 'STOPGRINDER' }))
        }

        function moveChain() {
            socket.send(JSON.stringify({ command: 'PUSHCHAIN' }))
        }

        function checkLengthGrinding() {
            socket.send(JSON.stringify({ command: 'CHECKLENGTHGRINDING' }))
        }

        function quitCheckLengthGrinding() {
            socket.send(JSON.stringify({ command: 'QUITCHECKLENGTHGRINDING' }))
        }

        function clampChain() {
            socket.send(JSON.stringify({ command: 'CLAMPCHAIN' }))
        }

        function releaseChain() {
            socket.send(JSON.stringify({ command: 'RELEASECHAIN' }))
        }

        ///////////////////////// Time stuff /////////////////////////////////

        function displayCurrentTime() {
            const today = new Date();
            const year = today.getFullYear()
            const month = today.getMonth() + 1
            const day = today.getDate()
            const h = today.getHours();
            let m = today.getMinutes();
            m = padWithZero(m);
            timeLabel.innerHTML = `${year}-${padWithZero(month)}-${padWithZero(day)} ${h}:${m}`
            setTimeout(displayCurrentTime, 1000);
        }

        function padWithZero(i) {
            if (i < 10) { i = "0" + i };  // add zero in front of numbers < 10
            return i;
        }


    </script>
</body>

</html>
